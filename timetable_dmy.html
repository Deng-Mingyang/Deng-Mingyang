<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2028考研备考时长统计系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 基础样式保留 */
        body { background-color: #f5f7f0 !important; }
        .card { box-shadow: 0 2px 8px rgba(100,120,80,0.1); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #ffffff !important; }
        .btn { @apply px-4 py-2 rounded-md text-white font-medium transition-all; }
        .btn-primary { @apply bg-emerald-600 hover:bg-emerald-700; }
        .btn-danger { @apply bg-rose-500 hover:bg-rose-600; }
        .btn-secondary { @apply bg-slate-600 hover:bg-slate-700; }
        .btn-warning { @apply bg-amber-500 hover:bg-amber-600; }
        .input { @apply w-full p-2 border border-emerald-100 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-400 bg-emerald-50; }
        .countdown-card { background-color: #f0f8f0 !important; border: 1px solid #d4e6d4; }
        .autocomplete-list { position: absolute; z-index: 10; width: calc(100% - 2rem); max-height: 120px; overflow-y-auto; background: #fff; border: 1px solid #d4e6d4; border-radius: 4px; }
        .autocomplete-item { padding: 0.5rem; cursor: pointer; }
        .autocomplete-item:hover { background-color: #f0f8f0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 400px; }
        .modal-buttons { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem; }
        .motivation-modal { z-index: 200; }
        .motivation-content { text-align: center; padding: 1.5rem; }
        .motivation-title { font-size: 1.1rem !important; margin-bottom: 0.8rem !important; }
        .motivation-quote { font-size: 0.95rem !important; line-height: 1.5 !important; margin: 0.8rem 0 !important; font-weight: 400 !important; }
        .timer-display { font-size: 1.5rem; font-weight: bold; text-align: center; margin: 0.5rem 0; color: #065f46; }
        .timer-buttons { display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.5rem; }
        .history-card { margin-top: 2rem; }
        .history-select { display: flex; gap: 1rem; align-items-center; margin-bottom: 1rem; }
        .history-list { max-height: 300px; overflow-y: auto; margin-top: 1rem; }
        .history-item { padding: 0.8rem; border-bottom: 1px solid #d4e6d4; cursor: pointer; transition: background-color 0.2s; }
        .history-item:hover { background-color: #f0f8f0; }
        .history-date { font-weight: 600; color: #065f46; }
        .history-total { color: #ef4444; }
        .total-stats-card { margin-top: 2rem; }
        .total-time-display { font-size: 1.8rem; font-weight: bold; text-align: center; color: #065f46; margin: 1rem 0; }
        .compare-card { margin-top: 2rem; }
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem; }
        .compare-column { padding: 1rem; border-radius: 6px; background-color: #f0f8f0; }
        .compare-date { font-weight: 600; color: #065f46; margin-bottom: 0.5rem; }
        .compare-total { color: #ef4444; font-weight: 500; margin-bottom: 0.5rem; }
        .custom-compare-card { margin-top: 2rem; }
        .custom-compare-select { display: flex; gap: 1rem; align-items-center; margin-bottom: 1rem; flex-wrap: wrap; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <!-- 每日励志弹窗（默认显示） -->
    <div id="motivationModal" class="modal motivation-modal">
        <div class="modal-content motivation-content">
            <h3 id="motivationTitle" class="text-xl font-bold motivation-title">💪 今日考研寄语</h3>
            <p id="dailyMotivation" class="motivation-quote"></p>
            <button id="startBtn" class="btn btn-primary">好的加油</button>
        </div>
    </div>
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-emerald-800 mb-6">📚 2028考研备考时长统计</h1>
        
        <!-- 自定义倒计时区域 -->
        <div class="card countdown-card mb-6">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">⏰ 自定义倒计时管理</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-emerald-800 mb-1">项目名称</label>
                    <input type="text" id="customCountdownName" class="input" placeholder="如：政治冲刺、英语模考">
                </div>
                <div>
                    <label class="block text-sm font-medium text-emerald-800 mb-1">目标日期</label>
                    <input type="date" id="customCountdownDate" class="input" min="" value="">
                </div>
                <div class="flex items-end">
                    <button id="addCustomCountdownBtn" class="btn btn-primary w-full">添加倒计时</button>
                </div>
            </div>
            <div id="customCountdownList" class="space-y-2">
                <!-- 倒计时列表将动态渲染 -->
            </div>
        </div>

        <!-- 考研倒计时区域（保留） -->
        <div class="card countdown-card mb-6">
            <h2 class="text-xl font-semibold text-emerald-700 mb-2 text-center">⏰ 2028考研倒计时</h2>
            <div id="countdown" class="flex justify-center space-x-4 text-center text-emerald-900">
                <div class="flex flex-col">
                    <span id="days" class="text-2xl font-bold">00</span>
                    <span class="text-sm">天</span>
                </div>
                <div class="flex flex-col">
                    <span id="hours" class="text-2xl font-bold">00</span>
                    <span class="text-sm">时</span>
                </div>
                <div class="flex flex-col">
                    <span id="minutes" class="text-2xl font-bold">00</span>
                    <span class="text-sm">分</span>
                </div>
                <div class="flex flex-col">
                    <span id="seconds" class="text-2xl font-bold">00</span>
                    <span class="text-sm">秒</span>
                </div>
            </div>
        </div>

        <!-- 今日记录区域（正向计时+双模式切换） -->
        <div class="card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">今日学习记录（<span id="todayDate"></span>）</h2>
            <!-- 模式切换 -->
            <div class="flex items-center mb-4 gap-4">
                <label class="text-emerald-800 font-medium">记录模式：</label>
                <label class="inline-flex items-center gap-1">
                    <input type="radio" name="recordMode" value="manual" checked class="accent-emerald-600">
                    <span class="text-emerald-800">手动输入时间段</span>
                </label>
                <label class="inline-flex items-center gap-1">
                    <input type="radio" name="recordMode" value="timer" class="accent-emerald-600">
                    <span class="text-emerald-800">正向计时</span>
                </label>
            </div>
            <!-- 手动输入模式（默认显示） -->
            <div id="manualMode" class="mb-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-emerald-800 mb-1">学习项目</label>
                        <input type="text" id="stageName" class="input" placeholder="如：MTI翻译、政治刷题">
                        <div id="autocompleteContainer" class="autocomplete-list hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-emerald-800 mb-1">开始时间</label>
                        <input type="time" id="startTime" class="input" value="08:00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-emerald-800 mb-1">结束时间</label>
                        <input type="time" id="endTime" class="input" value="09:00">
                    </div>
                    <div class="flex items-end">
                        <button id="addManualBtn" class="btn btn-primary w-full">添加记录</button>
                    </div>
                </div>
            </div>
            <!-- 正向计时模式（默认隐藏） -->
            <div id="timerMode" class="mb-4 hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative md:col-span-1">
                        <label class="block text-sm font-medium text-emerald-800 mb-1">学习项目</label>
                        <input type="text" id="timerStageName" class="input" placeholder="如：MTI翻译、政治刷题">
                        <div id="timerAutocompleteContainer" class="autocomplete-list hidden"></div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-emerald-800 mb-1">当前计时</label>
                        <div class="timer-display" id="timerDisplay">00:00:00</div>
                        <div class="timer-buttons">
                            <button id="startTimerBtn" class="btn btn-primary">开始计时</button>
                            <button id="pauseTimerBtn" class="btn btn-warning" disabled>暂停</button>
                            <button id="stopTimerBtn" class="btn btn-danger" disabled>结束并添加</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 今日学习列表 -->
            <div class="mb-4">
                <h3 class="text-md font-medium text-emerald-800 mb-2">今日学习列表（含时段）</h3>
                <div id="stageList" class="max-h-40 overflow-y-auto space-y-2"></div>
            </div>
            <!-- 今日总时长 -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <span class="text-emerald-800">今日总时长：</span>
                    <span id="todayTotal" class="text-xl font-bold text-emerald-600">0</span> 分钟
                </div>
                <button id="saveTodayBtn" class="btn btn-primary">保存今日记录</button>
            </div>
            <!-- 今日柱状图 -->
            <div id="todayChartContainer" class="h-60 hidden">
                <h3 class="text-md font-medium text-emerald-800 mb-2">今日学习时段分布（24小时）</h3>
                <canvas id="todayChart"></canvas>
            </div>
        </div>

        <!-- 当日昨日对比区域 -->
        <div class="card compare-card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">当日 vs 昨日 学习效果对比</h2>
            <div class="compare-grid">
                <div class="compare-column">
                    <div class="compare-date">今日（<span id="todayCompareDate"></span>）</div>
                    <div class="compare-total">总时长：<span id="todayCompareTotal">0</span> 分钟</div>
                    <div id="todayCompareStages" class="mt-2 space-y-1">
                        <!-- 今日项目列表将动态渲染 -->
                    </div>
                </div>
                <div class="compare-column">
                    <div class="compare-date">昨日（<span id="yesterdayCompareDate"></span>）</div>
                    <div class="compare-total">总时长：<span id="yesterdayCompareTotal">0</span> 分钟</div>
                    <div id="yesterdayCompareStages" class="mt-2 space-y-1">
                        <!-- 昨日项目列表将动态渲染 -->
                    </div>
                </div>
            </div>
            <div class="h-80 mt-4">
                <h3 class="text-md font-medium text-emerald-800 mb-2">时段分布对比</h3>
                <canvas id="compareChart"></canvas>
            </div>
        </div>

        <!-- 任意两天对比区域 -->
        <div class="card custom-compare-card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">任意两天学习效果对比</h2>
            <div class="custom-compare-select">
                <label class="block text-sm font-medium text-emerald-800 mb-1">选择日期1</label>
                <input type="date" id="customCompareDate1" class="input w-48">
                <label class="block text-sm font-medium text-emerald-800 mb-1">选择日期2</label>
                <input type="date" id="customCompareDate2" class="input w-48">
                <button id="viewCustomCompareBtn" class="btn btn-primary">查看对比</button>
            </div>
            <div id="customCompareResult" class="hidden">
                <div class="compare-grid">
                    <div class="compare-column" id="customCompareCol1">
                        <div class="compare-date" id="customDate1">日期1</div>
                        <div class="compare-total" id="customTotal1">总时长：0 分钟</div>
                        <div id="customStages1" class="mt-2 space-y-1">
                            <!-- 日期1项目列表将动态渲染 -->
                        </div>
                    </div>
                    <div class="compare-column" id="customCompareCol2">
                        <div class="compare-date" id="customDate2">日期2</div>
                        <div class="compare-total" id="customTotal2">总时长：0 分钟</div>
                        <div id="customStages2" class="mt-2 space-y-1">
                            <!-- 日期2项目列表将动态渲染 -->
                        </div>
                    </div>
                </div>
                <div class="h-80 mt-4">
                    <h3 class="text-md font-medium text-emerald-800 mb-2">时段分布对比</h3>
                    <canvas id="customCompareChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 月度统计区域 -->
        <div class="card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">月度学习统计</h2>
            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                <div>
                    <label class="block text-sm font-medium text-emerald-800 mb-1">选择月份</label>
                    <input type="month" id="selectMonth" class="input w-48">
                </div>
                <button id="viewStatsBtn" class="btn btn-primary">查看统计</button>
            </div>
            <div class="h-80">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>

        <!-- 全项目统计区域 -->
        <div class="card total-stats-card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">全项目学习时长统计</h2>
            <button id="calculateTotalTimeBtn" class="btn btn-primary mb-4">一键统计所有历史时长总和</button>
            <div class="total-time-display" id="totalTimeDisplay">点击上方按钮计算总时长</div>
            <div class="h-80 mt-4">
                <canvas id="allProjectsChart"></canvas>
            </div>
        </div>

        <!-- 过往记录查询区域 -->
        <div class="card history-card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">过往学习记录查询</h2>
            <div class="history-select">
                <label class="block text-sm font-medium text-emerald-800 mb-1">选择日期</label>
                <input type="date" id="historyDate" class="input w-48">
                <button id="viewHistoryBtn" class="btn btn-primary">查看记录</button>
            </div>
            <div id="historyList" class="history-list">
                <div class="text-center text-slate-500 py-4">请选择日期后点击“查看记录”</div>
            </div>
        </div>
    </div>

    <!-- 历史记录详情弹窗 -->
    <div id="historyDetailModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="historyDetailTitle" class="text-lg font-semibold text-emerald-800 mb-2">历史记录详情</h3>
            <div id="historyDetailContent" class="mb-4">
                <p class="text-emerald-700 mb-2">日期：<span id="detailDate"></span></p>
                <p class="text-emerald-700 mb-2">总时长：<span id="detailTotal"></span> 分钟</p>
                <h4 class="text-md font-medium text-emerald-800 mb-2">学习项目列表</h4>
                <div id="detailStageList" class="space-y-2"></div>
            </div>
            <div class="modal-buttons">
                <button id="closeDetailBtn" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 备份对话框（默认隐藏） -->
    <div id="backupModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-emerald-800 mb-2">备份网站数据</h3>
            <p class="text-emerald-700 mb-4">请选择目标文件夹，将自动覆盖旧文件</p>
            <div class="modal-buttons">
                <button id="cancelBackupBtn" class="btn btn-secondary">直接关闭（不备份）</button>
                <button id="confirmBackupBtn" class="btn btn-primary">选择文件夹并备份</button>
            </div>
        </div>
    </div>

    <script>
        // 1. 每日不重复励志语录库（50条）
        const motivationQuotes = [
            "每一次刷题都是在为梦想铺路，今天的坚持，就是明天的录取通知书！",
            "不必焦虑进度，专注当下的每一分钟，时间会给你最好的答案。",
            "考研就像黑屋子里洗衣服，你不知道洗干净了没有，只能一遍一遍去洗，等上了考场的那一刻，灯亮了，你发现有的人忘了加洗衣粉，有的人用的是洗衣机，但只要你认真洗过了每一个地方，那件衣服一定是洁白如新的，而你以后每次穿这件衣服时，都会想起那段岁月。",
            "现在多学一分钟，考场上就多一分底气，别让未来的自己后悔现在的懈怠。",
            "那些看似不起波澜的日复一日，会在某天让你看到坚持的意义。",
            "考研不是轻松的旅程，但每一步都算数，今天的努力，终将照亮前行的路。",
            "别害怕困难，你遇到的每一道难题，都是在筛选真正有决心的人，而你，一定是其中之一。",
            "把目标刻在心里，把努力落在实处，相信自己，你远比想象中更强大。",
            "清晨的书桌、深夜的灯光，都是你追梦的见证，坚持下去，终会上岸！",
            "不用和别人比进度，按自己的节奏稳步前进，每一个踏实的脚印都不会白走。",
            "学习很累，但放弃更可惜，再坚持一下，你离梦想就更近一步。",
            "考研路上的孤独与疲惫，都会在收到录取通知的那一刻化为值得。",
            "今天翻的书，就是明天数的钱；今天吃的苦，就是明天享的福。",
            "保持热爱，奔赴山海，考研是一场自我较量，赢了自己，就赢了一切。",
            "别给自己找借口，现在的每一份付出，都是未来的筹码。",
            "真正的对手不是别人，是昨天懒惰的自己，每天进步一点，就是胜利。",
            "没有一蹴而就的成功，只有日积月累的努力，考研加油！",
            "当你想放弃时，想想当初为什么出发，初心不改，方能始终。",
            "每一个挑灯夜读的夜晚，都在为你的未来积攒光芒。",
            "考研是一场持久战，熬得住就出众，熬不住就出局，你要做那个出众的人。",
            "知识点记不住就多背几遍，题不会做就多练几道，坚持住，胜利就在前方。",
            "不为模糊不清的未来担忧，只为清清楚楚的现在努力。",
            "你的坚持，终将美好；你的努力，必有回响。",
            "考研就像爬山，过程很累，但山顶的风景一定值得。",
            "今天的汗水，是明天的泪水（喜悦的），加油，考研人！",
            "别让任何人消耗你内心的晴朗，生活应该是被热爱的人和事填满的，考研亦是如此。",
            "努力的意义，在于可以选择自己想要的生活，而不是被迫接受不想要的。",
            "每一次坚持，都是对梦想的靠近，别轻易放弃。",
            "成功的路上并不拥挤，因为坚持的人不多，你再坚持一下，就能超过很多人。",
            "把“我不行”换成“我再试试”，你会发现自己远比想象中强大。",
            "考研不是为了逃避现实，而是为了给自己更多选择的权利。",
            "现在的辛苦，是为了以后能轻松地选择，而不是被迫地接受。",
            "别抱怨备考的苦，那是你去看世界的路。",
            "每一个早起的清晨，每一个晚睡的深夜，都在书写你的未来。",
            "坚持下去，不是因为看到了希望，而是因为努力了才能看到希望。",
            "考研路上，你不是一个人在战斗，还有千千万万的研友和你一起前行。",
            "知识不会辜负努力的人，你今天学的每一个知识点，都会在考场上帮到你。",
            "别纠结于过去的失误，专注于当下的学习，未来还可以改变。",
            "给自己一个目标，然后为之奋斗，你会发现自己的潜力无限。",
            "考研的意义不在于结果，而在于过程中你成为了更好的自己。",
            "累了就休息一下，但别放弃，调整好状态再继续出发。",
            "今天多学一点，明天就少慌一点，考研加油，你可以的！",
            "没有白费的努力，也没有碰巧的成功，每一步都很重要。",
            "把考研当成一场修行，在这个过程中磨练自己的意志，提升自己的能力。",
            "别让懒惰占据你的生活，行动起来，为自己的未来拼搏。",
            "你现在的努力，是为了以后能有更多的底气说“我可以”。",
            "考研就像一场马拉松，不在于起跑多快，而在于能否坚持到最后。",
            "每一个知识点的掌握，每一道题的攻克，都是你进步的证明。",
            "相信自己，你有能力实现自己的梦想，只要你愿意付出努力。"
        ];
        // 每日随机弹窗颜色（护眼色系）
        const randomColors = [
            '#065f46', '#10b981', '#059669', '#047857', '#34d399', 
            '#1e40af', '#3b82f6', '#2563eb', '#1d4ed8', '#3b82f6'
        ];
        const getRandomColor = () => {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            return randomColors[dayOfYear % randomColors.length];
        };
        // 初始化励志弹窗
        const motivationModal = document.getElementById('motivationModal');
        const motivationTitle = document.getElementById('motivationTitle');
        const dailyMotivation = document.getElementById('dailyMotivation');
        const motivationColor = getRandomColor();
        motivationTitle.style.color = motivationColor;
        dailyMotivation.style.color = motivationColor;
        dailyMotivation.textContent = motivationQuotes[Math.floor(Math.random() * motivationQuotes.length)];
        document.getElementById('startBtn').addEventListener('click', () => {
            motivationModal.classList.add('hidden');
        });

        // 2. 基础日期初始化
        const today = new Date();
        const formatDate = (date) => date.toISOString().split('T')[0];
        const formatMonth = (date) => date.toISOString().split('-').slice(0,2).join('-');
        document.getElementById('todayDate').textContent = formatDate(today);
        document.getElementById('todayCompareDate').textContent = formatDate(today);
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        document.getElementById('yesterdayCompareDate').textContent = formatDate(yesterday);
        document.getElementById('selectMonth').value = formatMonth(today);
        document.getElementById('historyDate').value = formatDate(today);
        document.getElementById('customCountdownDate').min = formatDate(today);

        // 3. 考研倒计时
        const targetDate = new Date('2027-12-24T08:30:00');
        const updateCountdown = () => {
            const now = new Date();
            const diff = targetDate - now;
            if (diff <= 0) {
                document.getElementById('days').textContent = '00';
                document.getElementById('hours').textContent = '00';
                document.getElementById('minutes').textContent = '00';
                document.getElementById('seconds').textContent = '00';
                return;
            }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('days').textContent = days.toString().padStart(2, '0');
            document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
        };
        updateCountdown();
        setInterval(updateCountdown, 1000);

        // 4. 自定义倒计时功能
        let customCountdowns = JSON.parse(localStorage.getItem('CustomCountdowns')) || [];
        const renderCustomCountdowns = () => {
            const listEl = document.getElementById('customCountdownList');
            listEl.innerHTML = customCountdowns.map((countdown, index) => `
                <div class="flex items-center justify-between p-2 bg-emerald-50 rounded-md border border-emerald-100">
                    <div>
                        <span class="text-emerald-900 font-medium">${countdown.name}</span>
                        <div id="customCountdown${index}" class="text-sm text-emerald-700">计算中...</div>
                    </div>
                    <button class="text-rose-500 hover:text-rose-600" onclick="removeCustomCountdown(${index})">删除</button>
                </div>
            `).join('');
            // 实时更新每个倒计时
            customCountdowns.forEach((countdown, index) => {
                const now = new Date();
                const target = new Date(countdown.date);
                const diff = target - now;
                if (diff <= 0) {
                    document.getElementById(`customCountdown${index}`).textContent = '已结束';
                    return;
                }
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                document.getElementById(`customCountdown${index}`).textContent = 
                    `${days}天${hours}时${minutes}分`;
            });
        };
        window.removeCustomCountdown = (index) => {
            customCountdowns.splice(index, 1);
            localStorage.setItem('CustomCountdowns', JSON.stringify(customCountdowns));
            renderCustomCountdowns();
        };
        document.getElementById('addCustomCountdownBtn').addEventListener('click', () => {
            const name = document.getElementById('customCountdownName').value.trim();
            const date = document.getElementById('customCountdownDate').value;
            if (!name || !date) {
                alert('请填写项目名称和目标日期');
                return;
            }
            customCountdowns.push({ name, date });
            localStorage.setItem('CustomCountdowns', JSON.stringify(customCountdowns));
            document.getElementById('customCountdownName').value = '';
            renderCustomCountdowns();
        });
        renderCustomCountdowns();

        // 5. 本地存储配置
        const STORAGE_KEY = '2028PostgradStudyRecord';
        const STAGE_NAMES_KEY = '2028PostgradStageNames';
        let todayStages = [];
        let studyData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        let stageNames = JSON.parse(localStorage.getItem(STAGE_NAMES_KEY)) || [];

        // 6. 图表初始化（月度饼图+今日柱状图+全项目饼图+对比柱状图）
        // 月度饼图
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        let monthlyChart = new Chart(monthlyCtx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#10b981', '#6ee7b7', '#34d399', '#059669', '#047857', '#065f46', '#064e3b'],
                    borderWidth: 1,
                    borderColor: '#f0f8f0'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#065f46' } },
                    title: { display: true, text: '月度学习时长分布', font: { size: 16, color: '#065f46' } }
                }
            }
        });

        // 今日柱状图
        const todayCtx = document.getElementById('todayChart').getContext('2d');
        let todayChart = new Chart(todayCtx, {
            type: 'bar',
            data: {
                labels: Array.from({length:24}, (_,i) => `${i}:00`),
                datasets: [{
                    label: '今日学习频率（分钟/小时）',
                    data: Array(24).fill(0),
                    backgroundColor: '#34d399',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: '时长（分钟）', color: '#065f46' } },
                    x: { title: { display: true, text: '时间段', color: '#065f46' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // 全项目饼图
        const allProjectsCtx = document.getElementById('allProjectsChart').getContext('2d');
        let allProjectsChart = new Chart(allProjectsCtx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#10b981', '#6ee7b7', '#34d399', '#059669', '#047857', '#065f46', '#064e3b'],
                    borderWidth: 1,
                    borderColor: '#f0f8f0'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#065f46' } },
                    title: { display: true, text: '所有学习项目时长分布', font: { size: 16, color: '#065f46' } }
                }
            }
        });

        // 当日昨日对比柱状图
        const compareCtx = document.getElementById('compareChart').getContext('2d');
        let compareChart = new Chart(compareCtx, {
            type: 'bar',
            data: {
                labels: Array.from({length:24}, (_,i) => `${i}:00`),
                datasets: [
                    {
                        label: '今日',
                        data: Array(24).fill(0),
                        backgroundColor: '#34d399',
                        borderRadius: 4
                    },
                    {
                        label: '昨日',
                        data: Array(24).fill(0),
                        backgroundColor: '#6ee7b7',
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: '时长（分钟）', color: '#065f46' } },
                    x: { title: { display: true, text: '时间段', color: '#065f46' } }
                }
            }
        });

        // 任意两天对比柱状图
        const customCompareCtx = document.getElementById('customCompareChart').getContext('2d');
        let customCompareChart = new Chart(customCompareCtx, {
            type: 'bar',
            data: {
                labels: Array.from({length:24}, (_,i) => `${i}:00`),
                datasets: [
                    {
                        label: '日期1',
                        data: Array(24).fill(0),
                        backgroundColor: '#34d399',
                        borderRadius: 4
                    },
                    {
                        label: '日期2',
                        data: Array(24).fill(0),
                        backgroundColor: '#6ee7b7',
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: '时长（分钟）', color: '#065f46' } },
                    x: { title: { display: true, text: '时间段', color: '#065f46' } }
                }
            }
        });

        // 7. 项目名自动联想（手动模式+计时模式）
        // 手动模式联想
        const stageNameInput = document.getElementById('stageName');
        const autocompleteContainer = document.getElementById('autocompleteContainer');
        // 计时模式联想
        const timerStageNameInput = document.getElementById('timerStageName');
        const timerAutocompleteContainer = document.getElementById('timerAutocompleteContainer');
        // 联想功能通用方法
        const renderAutocomplete = (inputVal, container) => {
            if (!inputVal) {
                container.classList.add('hidden');
                return;
            }
            const matches = stageNames.filter(name => name.toLowerCase().includes(inputVal.toLowerCase()));
            if (matches.length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.innerHTML = matches.map(name => 
                `<div class="autocomplete-item" onclick="selectStageName('${name}','${container.id}')">${name}</div>`
            ).join('');
            container.classList.remove('hidden');
        };
        // 选择联想项
        window.selectStageName = (name, containerId) => {
            if (containerId === 'autocompleteContainer') {
                stageNameInput.value = name;
                autocompleteContainer.classList.add('hidden');
            } else {
                timerStageNameInput.value = name;
                timerAutocompleteContainer.classList.add('hidden');
            }
        };
        // 手动模式输入监听
        stageNameInput.addEventListener('input', () => {
            renderAutocomplete(stageNameInput.value, autocompleteContainer);
        });
        // 计时模式输入监听
        timerStageNameInput.addEventListener('input', () => {
            renderAutocomplete(timerStageNameInput.value, timerAutocompleteContainer);
        });
        // 点击空白关闭联想框
        document.addEventListener('click', (e) => {
            if (!stageNameInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
                autocompleteContainer.classList.add('hidden');
            }
            if (!timerStageNameInput.contains(e.target) && !timerAutocompleteContainer.contains(e.target)) {
                timerAutocompleteContainer.classList.add('hidden');
            }
        });

        // 8. 模式切换逻辑（手动/正向计时）
        const manualMode = document.getElementById('manualMode');
        const timerMode = document.getElementById('timerMode');
        const recordModeRadios = document.querySelectorAll('input[name="recordMode"]');
        recordModeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'manual') {
                    manualMode.classList.remove('hidden');
                    timerMode.classList.add('hidden');
                } else {
                    manualMode.classList.add('hidden');
                    timerMode.classList.remove('hidden');
                }
            });
        });

        // 9. 手动输入模式 - 计算时长与添加记录
        const calculateDuration = (start, end) => {
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            const startTotal = startH * 60 + startM;
            const endTotal = endH * 60 + endM;
            return endTotal >= startTotal ? endTotal - startTotal : (endTotal + 1440) - startTotal;
        };
        // 渲染今日学习列表
        const renderStageList = () => {
            const listEl = document.getElementById('stageList');
            listEl.innerHTML = todayStages.map((stage, index) => `
                <div class="flex items-center justify-between p-2 bg-emerald-50 rounded-md border border-emerald-100">
                    <div>
                        <span class="text-emerald-900 font-medium">${stage.name}</span>
                        <span class="text-emerald-700 text-sm ml-2">${stage.startTime} - ${stage.endTime}</span>
                        <span class="text-emerald-600 ml-2">(${stage.duration}分钟)</span>
                    </div>
                    <button class="text-rose-500 hover:text-rose-600" onclick="removeStage(${index})">删除</button>
                </div>
            `).join('');
            // 更新今日总时长
            const total = todayStages.reduce((sum, s) => sum + s.duration, 0);
            document.getElementById('todayTotal').textContent = total;
        };
        // 删除学习记录（删除后立即同步保存，记录彻底消失）
        window.removeStage = (index) => {
            todayStages.splice(index, 1);
            renderStageList();
            // 同步更新本地存储
            const todayKey = formatDate(today);
            studyData[todayKey] = { stages: [...todayStages], total: todayStages.reduce((sum, s) => sum + s.duration, 0), date: todayKey };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(studyData));
        };
        // 手动添加记录
        document.getElementById('addManualBtn').addEventListener('click', () => {
            const name = stageNameInput.value.trim();
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            if (!name || !startTime || !endTime) {
                alert('请填写完整学习项目和时间段');
                return;
            }
            const duration = calculateDuration(startTime, endTime);
            if (duration < 1) {
                alert('时长需大于1分钟');
                return;
            }
            // 缓存项目名（去重）
            if (!stageNames.includes(name)) {
                stageNames.push(name);
                localStorage.setItem(STAGE_NAMES_KEY, JSON.stringify(stageNames));
            }
            // 添加到今日列表
            todayStages.push({ name, startTime, endTime, duration });
            stageNameInput.value = '';
            renderStageList();
        });

        // 10. 正向计时模式 - 计时逻辑
        let timerInterval = null;
        let timerSeconds = 0;
        const timerDisplay = document.getElementById('timerDisplay');
        const startTimerBtn = document.getElementById('startTimerBtn');
        const pauseTimerBtn = document.getElementById('pauseTimerBtn');
        const stopTimerBtn = document.getElementById('stopTimerBtn');
        // 格式化时间（秒转时分秒）
        const formatTimer = (seconds) => {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        };
        // 开始计时
        startTimerBtn.addEventListener('click', () => {
            timerInterval = setInterval(() => {
                timerSeconds++;
                timerDisplay.textContent = formatTimer(timerSeconds);
            }, 1000);
            startTimerBtn.disabled = true;
            pauseTimerBtn.disabled = false;
            stopTimerBtn.disabled = false;
        });
        // 暂停计时
        pauseTimerBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            startTimerBtn.disabled = false;
            pauseTimerBtn.disabled = true;
        });
        // 结束计时并添加记录
        stopTimerBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            const name = timerStageNameInput.value.trim();
            if (!name) {
                alert('请填写学习项目名称');
                // 重置计时状态
                timerSeconds = 0;
                timerDisplay.textContent = '00:00:00';
                startTimerBtn.disabled = false;
                pauseTimerBtn.disabled = true;
                stopTimerBtn.disabled = true;
                return;
            }
            // 计算开始/结束时间（当前时间倒推时长）
            const endTime = new Date();
            const startTime = new Date(endTime - timerSeconds * 1000);
            // 格式化时间为 HH:MM
            const formatTime = (date) => date.toTimeString().slice(0, 5);
            const startStr = formatTime(startTime);
            const endStr = formatTime(endTime);
            const duration = Math.floor(timerSeconds / 60); // 转分钟（不足1分钟按1分钟算）
            
            // 缓存项目名（去重）
            if (!stageNames.includes(name)) {
                stageNames.push(name);
                localStorage.setItem(STAGE_NAMES_KEY, JSON.stringify(stageNames));
            }
            // 添加到今日列表
            todayStages.push({ name, startTime: startStr, endTime: endStr, duration: duration || 1 });
            // 重置计时状态
            timerSeconds = 0;
            timerDisplay.textContent = '00:00:00';
            timerStageNameInput.value = '';
            startTimerBtn.disabled = false;
            pauseTimerBtn.disabled = true;
            stopTimerBtn.disabled = true;
            // 重新渲染列表
            renderStageList();
        });

        // 11. 保存今日记录
        document.getElementById('saveTodayBtn').addEventListener('click', () => {
            if (todayStages.length === 0) {
                alert('今日暂无学习记录可保存');
                return;
            }
            const todayKey = formatDate(today);
            const total = todayStages.reduce((sum, s) => sum + s.duration, 0);
            studyData[todayKey] = { stages: [...todayStages], total, date: todayKey };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(studyData));
            
            // 生成今日时段分布数据
            const hourData = Array(24).fill(0);
            todayStages.forEach(stage => {
                const [startH, startM] = stage.startTime.split(':').map(Number);
                const [endH, endM] = stage.endTime.split(':').map(Number);
                const startTotal = startH * 60 + startM;
                const endTotal = endH * 60 + endM;
                
                if (endTotal >= startTotal) {
                    // 同一时段内
                    for (let m = startTotal; m < endTotal; m++) {
                        const hour = Math.floor(m / 60);
                        hourData[hour]++;
                    }
                } else {
                    // 跨凌晨
                    for (let m = startTotal; m < 1440; m++) {
                        const hour = Math.floor(m / 60);
                        hourData[hour]++;
                    }
                    for (let m = 0; m < endTotal; m++) {
                        const hour = Math.floor(m / 60);
                        hourData[hour]++;
                    }
                }
            });
            todayChart.data.datasets[0].data = hourData;
            todayChart.update();
            document.getElementById('todayChartContainer').classList.remove('hidden');
            alert('今日记录保存成功！');
        });

        // 12. 月度统计查询
        document.getElementById('viewStatsBtn').addEventListener('click', () => {
            const selectedMonth = document.getElementById('selectMonth').value;
            if (!selectedMonth) return;
            // 筛选当月记录
            const monthRecords = Object.entries(studyData).filter(([date]) => date.startsWith(selectedMonth));
            if (monthRecords.length === 0) {
                monthlyChart.data.labels = ['无数据'];
                monthlyChart.data.datasets[0].data = [1];
                monthlyChart.update();
                return;
            }
            // 统计各项目总时长
            const stageStats = {};
            monthRecords.forEach(([_, data]) => {
                data.stages.forEach(stage => {
                    stageStats[stage.name] = (stageStats[stage.name] || 0) + stage.duration;
                });
            });
            // 更新图表
            monthlyChart.data.labels = Object.keys(stageStats);
            monthlyChart.data.datasets[0].data = Object.values(stageStats);
            const totalMonthTime = Object.values(stageStats).reduce((a, b) => a + b, 0);
            monthlyChart.options.plugins.title.text = `${selectedMonth} 学习时长分布（总：${totalMonthTime}分钟）`;
            monthlyChart.update();
        });

        // 13. 全项目统计
        document.getElementById('calculateTotalTimeBtn').addEventListener('click', () => {
            let totalMinutes = 0;
            Object.values(studyData).forEach(data => {
                totalMinutes += data.total;
            });
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            document.getElementById('totalTimeDisplay').textContent = `总时长：${hours}小时${minutes}分钟`;
            
            // 统计所有项目总时长
            const allProjectsStats = {};
            Object.values(studyData).forEach(data => {
                data.stages.forEach(stage => {
                    allProjectsStats[stage.name] = (allProjectsStats[stage.name] || 0) + stage.duration;
                });
            });
            allProjectsChart.data.labels = Object.keys(allProjectsStats);
            allProjectsChart.data.datasets[0].data = Object.values(allProjectsStats);
            allProjectsChart.update();
        });

        // 14. 过往记录查询功能
        // 渲染历史记录列表
        const renderHistoryList = () => {
            const historyListEl = document.getElementById('historyList');
            if (Object.keys(studyData).length === 0) {
                historyListEl.innerHTML = '<div class="text-center text-slate-500 py-4">暂无历史记录</div>';
                return;
            }
            // 按日期倒序排列
            const sortedDates = Object.keys(studyData).sort((a, b) => new Date(b) - new Date(a));
            historyListEl.innerHTML = sortedDates.map(date => {
                const data = studyData[date];
                return `
                    <div class="history-item" onclick="showHistoryDetail('${date}')">
                        <div class="history-date">${date}</div>
                        <div>总时长：<span class="history-total">${data.total}分钟</span></div>
                    </div>
                `;
            }).join('');
        };
        // 查看历史记录详情
        window.showHistoryDetail = (date) => {
            const data = studyData[date];
            if (!data) return;
            document.getElementById('detailDate').textContent = date;
            document.getElementById('detailTotal').textContent = data.total;
            const detailStageListEl = document.getElementById('detailStageList');
            detailStageListEl.innerHTML = data.stages.map(stage => `
                <div class="p-2 bg-emerald-50 rounded-md border border-emerald-100">
                    <span class="text-emerald-900 font-medium">${stage.name}</span>
                    <span class="text-emerald-700 text-sm ml-2">${stage.startTime} - ${stage.endTime}</span>
                    <span class="text-emerald-600 ml-2">(${stage.duration}分钟)</span>
                </div>
            `).join('');
            document.getElementById('historyDetailModal').classList.remove('hidden');
        };
        // 绑定查看历史记录按钮
        document.getElementById('viewHistoryBtn').addEventListener('click', () => {
            const selectedDate = document.getElementById('historyDate').value;
            if (!selectedDate) {
                renderHistoryList();
                return;
            }
            if (studyData[selectedDate]) {
                showHistoryDetail(selectedDate);
            } else {
                alert('该日期无记录，请选择其他日期或查看全部历史记录');
                renderHistoryList();
            }
        });
        // 关闭详情弹窗
        document.getElementById('closeDetailBtn').addEventListener('click', () => {
            document.getElementById('historyDetailModal').classList.add('hidden');
        });
        // 初始化历史记录列表
        renderHistoryList();

        // 15. 当日昨日对比功能
        const renderTodayYesterdayCompare = () => {
            const todayKey = formatDate(today);
            const yesterdayKey = formatDate(yesterday);
            const todayData = studyData[todayKey] || { stages: [], total: 0 };
            const yesterdayData = studyData[yesterdayKey] || { stages: [], total: 0 };
            
            document.getElementById('todayCompareTotal').textContent = todayData.total;
            document.getElementById('yesterdayCompareTotal').textContent = yesterdayData.total;
            
            const todayStagesEl = document.getElementById('todayCompareStages');
            todayStagesEl.innerHTML = todayData.stages.map(stage => `
                <div class="text-sm">${stage.name}（${stage.duration}分钟）</div>
            `).join('');
            
            const yesterdayStagesEl = document.getElementById('yesterdayCompareStages');
            yesterdayStagesEl.innerHTML = yesterdayData.stages.map(stage => `
                <div class="text-sm">${stage.name}（${stage.duration}分钟）</div>
            `).join('');
            
            // 生成时段对比数据
            const todayHourData = Array(24).fill(0);
            if (todayData.stages) {
                todayData.stages.forEach(stage => {
                    const [startH, startM] = stage.startTime.split(':').map(Number);
                    const [endH, endM] = stage.endTime.split(':').map(Number);
                    const startTotal = startH * 60 + startM;
                    const endTotal = endH * 60 + endM;
                    
                    if (endTotal >= startTotal) {
                        for (let m = startTotal; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            todayHourData[hour]++;
                        }
                    } else {
                        for (let m = startTotal; m < 1440; m++) {
                            const hour = Math.floor(m / 60);
                            todayHourData[hour]++;
                        }
                        for (let m = 0; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            todayHourData[hour]++;
                        }
                    }
                });
            }
            
            const yesterdayHourData = Array(24).fill(0);
            if (yesterdayData.stages) {
                yesterdayData.stages.forEach(stage => {
                    const [startH, startM] = stage.startTime.split(':').map(Number);
                    const [endH, endM] = stage.endTime.split(':').map(Number);
                    const startTotal = startH * 60 + startM;
                    const endTotal = endH * 60 + endM;
                    
                    if (endTotal >= startTotal) {
                        for (let m = startTotal; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            yesterdayHourData[hour]++;
                        }
                    } else {
                        for (let m = startTotal; m < 1440; m++) {
                            const hour = Math.floor(m / 60);
                            yesterdayHourData[hour]++;
                        }
                        for (let m = 0; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            yesterdayHourData[hour]++;
                        }
                    }
                });
            }
            
            compareChart.data.datasets[0].data = todayHourData;
            compareChart.data.datasets[1].data = yesterdayHourData;
            compareChart.update();
        };
        renderTodayYesterdayCompare();

        // 16. 任意两天对比功能
        document.getElementById('viewCustomCompareBtn').addEventListener('click', () => {
            const date1 = document.getElementById('customCompareDate1').value;
            const date2 = document.getElementById('customCompareDate2').value;
            if (!date1 || !date2) {
                alert('请选择两个日期');
                return;
            }
            const data1 = studyData[date1] || { stages: [], total: 0, date: date1 };
            const data2 = studyData[date2] || { stages: [], total: 0, date: date2 };
            
            document.getElementById('customDate1').textContent = date1;
            document.getElementById('customDate2').textContent = date2;
            document.getElementById('customTotal1').textContent = `总时长：${data1.total} 分钟`;
            document.getElementById('customTotal2').textContent = `总时长：${data2.total} 分钟`;
            
            const stages1El = document.getElementById('customStages1');
            stages1El.innerHTML = data1.stages.map(stage => `
                <div class="text-sm">${stage.name}（${stage.duration}分钟）</div>
            `).join('');
            
            const stages2El = document.getElementById('customStages2');
            stages2El.innerHTML = data2.stages.map(stage => `
                <div class="text-sm">${stage.name}（${stage.duration}分钟）</div>
            `).join('');
            
            // 生成时段对比数据
            const hourData1 = Array(24).fill(0);
            if (data1.stages) {
                data1.stages.forEach(stage => {
                    const [startH, startM] = stage.startTime.split(':').map(Number);
                    const [endH, endM] = stage.endTime.split(':').map(Number);
                    const startTotal = startH * 60 + startM;
                    const endTotal = endH * 60 + endM;
                    
                    if (endTotal >= startTotal) {
                        for (let m = startTotal; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            hourData1[hour]++;
                        }
                    } else {
                        for (let m = startTotal; m < 1440; m++) {
                            const hour = Math.floor(m / 60);
                            hourData1[hour]++;
                        }
                        for (let m = 0; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            hourData1[hour]++;
                        }
                    }
                });
            }
            
            const hourData2 = Array(24).fill(0);
            if (data2.stages) {
                data2.stages.forEach(stage => {
                    const [startH, startM] = stage.startTime.split(':').map(Number);
                    const [endH, endM] = stage.endTime.split(':').map(Number);
                    const startTotal = startH * 60 + startM;
                    const endTotal = endH * 60 + endM;
                    
                    if (endTotal >= startTotal) {
                        for (let m = startTotal; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            hourData2[hour]++;
                        }
                    } else {
                        for (let m = startTotal; m < 1440; m++) {
                            const hour = Math.floor(m / 60);
                            hourData2[hour]++;
                        }
                        for (let m = 0; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            hourData2[hour]++;
                        }
                    }
                });
            }
            
            customCompareChart.data.datasets[0].data = hourData1;
            customCompareChart.data.datasets[1].data = hourData2;
            customCompareChart.update();
            document.getElementById('customCompareResult').classList.remove('hidden');
        });

        // 17. 初始化今日记录
        const initTodayRecords = () => {
            const todayKey = formatDate(today);
            if (studyData[todayKey]) {
                todayStages = [...studyData[todayKey].stages];
                renderStageList();
                // 初始化今日柱状图
                const hourData = Array(24).fill(0);
                todayStages.forEach(stage => {
                    const [startH, startM] = stage.startTime.split(':').map(Number);
                    const [endH, endM] = stage.endTime.split(':').map(Number);
                    const startTotal = startH * 60 + startM;
                    const endTotal = endH * 60 + endM;
                    if (endTotal >= startTotal) {
                        for (let m = startTotal; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            hourData[hour]++;
                        }
                    } else {
                        for (let m = startTotal; m < 1440; m++) {
                            const hour = Math.floor(m / 60);
                            hourData[hour]++;
                        }
                        for (let m = 0; m < endTotal; m++) {
                            const hour = Math.floor(m / 60);
                            hourData[hour]++;
                        }
                    }
                });
                todayChart.data.datasets[0].data = hourData;
                todayChart.update();
                document.getElementById('todayChartContainer').classList.remove('hidden');
            }
        };
        initTodayRecords();
        document.getElementById('viewStatsBtn').click();

        // 18. 关闭页面备份功能
        const backupModal = document.getElementById('backupModal');
        const cancelBackupBtn = document.getElementById('cancelBackupBtn');
        const confirmBackupBtn = document.getElementById('confirmBackupBtn');
        let isBackupCompleted = false;
        // 显示备份对话框
        const showBackupModal = () => {
            backupModal.classList.remove('hidden');
        };
        // 取消备份并关闭
        cancelBackupBtn.addEventListener('click', () => {
            backupModal.classList.add('hidden');
            isBackupCompleted = true;
            window.close();
        });
        // 确认备份（选择文件夹+覆盖旧文件）
        confirmBackupBtn.addEventListener('click', async () => {
            try {
                const htmlContent = document.documentElement.outerHTML;
                const blob = new Blob([htmlContent], { type: 'text/html' });
                // 触发系统文件选择器
                const handle = await window.showSaveFilePicker({
                    suggestedName: '考研时长统计.html',
                    types: [{
                        description: 'HTML文件',
                        accept: { 'text/html': ['.html'] }
                    }],
                    excludeAcceptAllOption: true
                });
                // 覆盖写入文件
                const writable = await handle.createWritable({ keepExistingData: false });
                await writable.write(blob);
                await writable.close();
                backupModal.classList.add('hidden');
                isBackupCompleted = true;
                alert('备份成功！已覆盖目标文件夹旧文件');
                window.close();
            } catch (err) {
                alert('备份取消或失败：' + err.message);
            }
        });
        // 监听页面关闭事件
        window.addEventListener('beforeunload', (e) => {
            if (isBackupCompleted) return;
            e.preventDefault();
            e.returnValue = '';
            showBackupModal();
            return e.returnValue;
        });
    </script>
</body>
</html>