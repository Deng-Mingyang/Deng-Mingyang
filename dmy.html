<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2028è€ƒç ”å¤‡è€ƒæ—¶é•¿ç»Ÿè®¡ï¼ˆäº‘ç«¯äº’é€šç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥å›½å†…äº‘ç«¯åŒæ­¥SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.17.0/dist/av-min.js"></script>
    <style>
        body { background-color: #f5f7f0 !important; }
        .card { box-shadow: 0 2px 8px rgba(100,120,80,0.1); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background-color: #ffffff !important; }
        .btn { @apply px-4 py-2 rounded-md text-white font-medium transition-all; }
        .btn-primary { @apply bg-emerald-600 hover:bg-emerald-700; }
        .btn-danger { @apply bg-rose-500 hover:bg-rose-600; }
        .btn-secondary { @apply bg-slate-600 hover:bg-slate-700; }
        .btn-warning { @apply bg-amber-500 hover:bg-amber-600; }
        .input { @apply w-full p-2 border border-emerald-100 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-400 bg-emerald-50; }
        .countdown-card { background-color: #f0f8f0 !important; border: 1px solid #d4e6d4; }
        .autocomplete-list { position: absolute; z-index: 10; width: calc(100% - 2rem); max-height: 120px; overflow-y: auto; background: #fff; border: 1px solid #d4e6d4; border-radius: 4px; }
        .autocomplete-item { padding: 0.5rem; cursor: pointer; }
        .autocomplete-item:hover { background-color: #f0f8f0; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 400px; }
        .timer-display { font-size: 1.5rem; font-weight: bold; text-align: center; margin: 0.5rem 0; color: #065f46; }
        .timer-buttons { display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.5rem; }
        .history-list { max-height: 300px; overflow-y: auto; margin-top: 1rem; }
        .history-item { padding: 0.8rem; border-bottom: 1px solid #d4e6d4; cursor: pointer; transition: background-color 0.2s; }
        .history-item:hover { background-color: #f0f8f0; }
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem; }
        .compare-column { padding: 1rem; border-radius: 6px; background-color: #f0f8f0; }
        .compare-date { font-weight: 600; color: #065f46; margin-bottom: 0.5rem; }
        .compare-total { color: #ef4444; font-weight: 500; margin-bottom: 0.5rem; }
        /* äº‘ç«¯åŒæ­¥æ¨¡å—æ ·å¼ */
        .cloud-sync-card { margin: 20px auto; max-width: 1000px; }
        .sync-controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
        .sync-status { font-size: 0.9rem; color: #065f46; margin-top: 0.5rem; }
        .sync-status.error { color: #ef4444; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-emerald-800 mb-6">ğŸ“š 2028è€ƒç ”å¤‡è€ƒæ—¶é•¿ç»Ÿè®¡ï¼ˆäº‘ç«¯äº’é€šç‰ˆï¼‰</h1>

        <!-- æ–°å¢ï¼šå›½å†…äº‘ç«¯åŒæ­¥æ¨¡å— -->
        <div class="card cloud-sync-card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">â˜ï¸ ç”µè„‘/æ‰‹æœºäº‘ç«¯åŒæ­¥</h2>
            <div class="sync-controls">
                <label class="block text-sm font-medium text-emerald-800 mb-1">åŒæ­¥IDï¼ˆå¤šç«¯éœ€ä¸€è‡´ï¼‰ï¼š</label>
                <input type="text" id="syncUserId" class="input w-64" placeholder="å¦‚ï¼šè€ƒç ”2025_å°æ˜" value="">
                <button id="uploadToCloudBtn" class="btn btn-primary">ä¸Šä¼ æœ¬åœ°è®°å½•åˆ°äº‘ç«¯</button>
                <button id="pullFromCloudBtn" class="btn btn-secondary">ä»äº‘ç«¯æ‹‰å–è®°å½•åˆ°æœ¬åœ°</button>
            </div>
            <div id="syncStatus" class="sync-status">æœªæ“ä½œï¼Œè¾“å…¥åŒæ­¥IDåå¯åŒæ­¥æ•°æ®</div>
        </div>

        <!-- è‡ªå®šä¹‰å€’è®¡æ—¶ç®¡ç† -->
        <div class="card countdown-card mb-6">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">â° è‡ªå®šä¹‰å€’è®¡æ—¶ç®¡ç†</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-emerald-800 mb-1">é¡¹ç›®åç§°</label>
                    <input type="text" id="customCountdownName" class="input" placeholder="å¦‚ï¼šæ”¿æ²»å†²åˆºã€è‹±è¯­æ¨¡è€ƒ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-emerald-800 mb-1">ç›®æ ‡æ—¥æœŸ</label>
                    <input type="date" id="customCountdownDate" class="input" min="" value="">
                </div>
                <div class="flex items-end">
                    <button id="addCustomCountdownBtn" class="btn btn-primary w-full">æ·»åŠ å€’è®¡æ—¶</button>
                </div>
            </div>
            <div id="customCountdownList" class="space-y-2">
                <!-- å€’è®¡æ—¶åˆ—è¡¨åŠ¨æ€æ¸²æŸ“ -->
            </div>
        </div>

        <!-- 2028è€ƒç ”å€’è®¡æ—¶ -->
        <div class="card countdown-card mb-6">
            <h2 class="text-xl font-semibold text-emerald-700 mb-2 text-center">â° 2028è€ƒç ”å€’è®¡æ—¶</h2>
            <div id="countdown" class="flex justify-center space-x-4 text-center text-emerald-900">
                <div class="flex flex-col">
                    <span id="days" class="text-2xl font-bold">785</span>
                    <span class="text-sm">å¤©</span>
                </div>
                <div class="flex flex-col">
                    <span id="hours" class="text-2xl font-bold">08</span>
                    <span class="text-sm">æ—¶</span>
                </div>
                <div class="flex flex-col">
                    <span id="minutes" class="text-2xl font-bold">31</span>
                    <span class="text-sm">åˆ†</span>
                </div>
                <div class="flex flex-col">
                    <span id="seconds" class="text-2xl font-bold">35</span>
                    <span class="text-sm">ç§’</span>
                </div>
            </div>
        </div>

        <!-- ä»Šæ—¥å­¦ä¹ è®°å½• -->
        <div class="card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">ä»Šæ—¥å­¦ä¹ è®°å½•ï¼ˆ<span id="todayDate">2025-10-29</span>ï¼‰</h2>
            <!-- è®°å½•æ¨¡å¼åˆ‡æ¢ -->
            <div class="flex items-center mb-4 gap-4">
                <label class="text-emerald-800 font-medium">è®°å½•æ¨¡å¼ï¼š</label>
                <label class="inline-flex items-center gap-1">
                    <input type="radio" name="recordMode" value="manual" checked class="accent-emerald-600">
                    <span class="text-emerald-800">æ‰‹åŠ¨è¾“å…¥æ—¶é—´æ®µ</span>
                </label>
                <label class="inline-flex items-center gap-1">
                    <input type="radio" name="recordMode" value="timer" class="accent-emerald-600">
                    <span class="text-emerald-800">æ­£å‘è®¡æ—¶</span>
                </label>
            </div>

            <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
            <div id="manualMode" class="mb-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-emerald-800 mb-1">å­¦ä¹ é¡¹ç›®</label>
                        <input type="text" id="stageName" class="input" placeholder="å¦‚ï¼šMTIç¿»è¯‘ã€æ”¿æ²»åˆ·é¢˜">
                        <div id="autocompleteContainer" class="autocomplete-list hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-emerald-800 mb-1">å¼€å§‹æ—¶é—´</label>
                        <input type="time" id="startTime" class="input" value="08:00">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-emerald-800 mb-1">ç»“æŸæ—¶é—´</label>
                        <input type="time" id="endTime" class="input" value="09:00">
                    </div>
                    <div class="flex items-end">
                        <button id="addManualBtn" class="btn btn-primary w-full">æ·»åŠ è®°å½•</button>
                    </div>
                </div>
            </div>

            <!-- æ­£å‘è®¡æ—¶æ¨¡å¼ -->
            <div id="timerMode" class="mb-4 hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative md:col-span-1">
                        <label class="block text-sm font-medium text-emerald-800 mb-1">å­¦ä¹ é¡¹ç›®</label>
                        <input type="text" id="timerStageName" class="input" placeholder="å¦‚ï¼šMTIç¿»è¯‘ã€æ”¿æ²»åˆ·é¢˜">
                        <div id="timerAutocompleteContainer" class="autocomplete-list hidden"></div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-emerald-800 mb-1">å½“å‰è®¡æ—¶</label>
                        <div class="timer-display" id="timerDisplay">00:00:00</div>
                        <div class="timer-buttons">
                            <button id="startTimerBtn" class="btn btn-primary">å¼€å§‹è®¡æ—¶</button>
                            <button id="pauseTimerBtn" class="btn btn-warning" disabled>æš‚åœ</button>
                            <button id="stopTimerBtn" class="btn btn-danger" disabled>ç»“æŸå¹¶æ·»åŠ </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»Šæ—¥å­¦ä¹ åˆ—è¡¨ -->
            <div class="mb-4">
                <h3 class="text-md font-medium text-emerald-800 mb-2">ä»Šæ—¥å­¦ä¹ åˆ—è¡¨ï¼ˆå«æ—¶æ®µï¼‰</h3>
                <div id="stageList" class="max-h-40 overflow-y-auto space-y-2">
                    <!-- å­¦ä¹ è®°å½•åŠ¨æ€æ¸²æŸ“ -->
                </div>
            </div>

            <!-- ä»Šæ—¥æ€»æ—¶é•¿ -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <span class="text-emerald-800">ä»Šæ—¥æ€»æ—¶é•¿ï¼š</span>
                    <span id="todayTotal" class="text-xl font-bold text-emerald-600">0</span> åˆ†é’Ÿ
                </div>
                <button id="saveTodayBtn" class="btn btn-primary">ä¿å­˜ä»Šæ—¥è®°å½•</button>
            </div>

            <!-- ä»Šæ—¥æ—¶æ®µåˆ†å¸ƒå›¾è¡¨ -->
            <div id="todayChartContainer" class="h-60">
                <h3 class="text-md font-medium text-emerald-800 mb-2">ä»Šæ—¥å­¦ä¹ æ—¶æ®µåˆ†å¸ƒï¼ˆ24å°æ—¶ï¼‰</h3>
                <canvas id="todayChart"></canvas>
            </div>
        </div>

        <!-- å½“æ—¥æ˜¨æ—¥å¯¹æ¯” -->
        <div class="card compare-card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">å½“æ—¥ vs æ˜¨æ—¥ å­¦ä¹ æ•ˆæœå¯¹æ¯”</h2>
            <div class="compare-grid">
                <div class="compare-column">
                    <div class="compare-date">ä»Šæ—¥ï¼ˆ<span id="todayCompareDate">2025-10-29</span>ï¼‰</div>
                    <div class="compare-total">æ€»æ—¶é•¿ï¼š<span id="todayCompareTotal">0</span> åˆ†é’Ÿ</div>
                    <div id="todayCompareStages" class="mt-2 space-y-1">
                        <!-- ä»Šæ—¥é¡¹ç›®åˆ—è¡¨åŠ¨æ€æ¸²æŸ“ -->
                    </div>
                </div>
                <div class="compare-column">
                    <div class="compare-date">æ˜¨æ—¥ï¼ˆ<span id="yesterdayCompareDate">2025-10-28</span>ï¼‰</div>
                    <div class="compare-total">æ€»æ—¶é•¿ï¼š<span id="yesterdayCompareTotal">0</span> åˆ†é’Ÿ</div>
                    <div id="yesterdayCompareStages" class="mt-2 space-y-1">
                        <!-- æ˜¨æ—¥é¡¹ç›®åˆ—è¡¨åŠ¨æ€æ¸²æŸ“ -->
                    </div>
                </div>
            </div>
            <div class="h-80 mt-4">
                <h3 class="text-md font-medium text-emerald-800 mb-2">æ—¶æ®µåˆ†å¸ƒå¯¹æ¯”</h3>
                <canvas id="compareChart"></canvas>
            </div>
        </div>

        <!-- ä»»æ„ä¸¤å¤©å¯¹æ¯” -->
        <div class="card compare-card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">ä»»æ„ä¸¤å¤©å­¦ä¹ æ•ˆæœå¯¹æ¯”</h2>
            <div class="flex gap-4 flex-wrap mb-4">
                <div>
                    <label class="block text-sm font-medium text-emerald-800 mb-1">é€‰æ‹©æ—¥æœŸ1</label>
                    <input type="date" id="customDate1" class="input w-48" value="2025-10-29">
                </div>
                <div>
                    <label class="block text-sm font-medium text-emerald-800 mb-1">é€‰æ‹©æ—¥æœŸ2</label>
                    <input type="date" id="customDate2" class="input w-48" value="2025-10-28">
                </div>
                <div class="flex items-end">
                    <button id="customCompareBtn" class="btn btn-primary">å¼€å§‹å¯¹æ¯”</button>
                </div>
            </div>
            <div class="compare-grid">
                <div class="compare-column">
                    <div class="compare-date" id="customDate1Title">æ—¥æœŸ1ï¼ˆ2025-10-29ï¼‰</div>
                    <div class="compare-total">æ€»æ—¶é•¿ï¼š<span id="customTotal1">0</span> åˆ†é’Ÿ</div>
                    <div id="customStages1" class="mt-2 space-y-1">
                        <span class="text-gray-500 text-sm">æš‚æ— è®°å½•</span>
                    </div>
                </div>
                <div class="compare-column">
                    <div class="compare-date" id="customDate2Title">æ—¥æœŸ2ï¼ˆ2025-10-28ï¼‰</div>
                    <div class="compare-total">æ€»æ—¶é•¿ï¼š<span id="customTotal2">0</span> åˆ†é’Ÿ</div>
                    <div id="customStages2" class="mt-2 space-y-1">
                        <span class="text-gray-500 text-sm">æš‚æ— è®°å½•</span>
                    </div>
                </div>
            </div>
            <div class="h-80 mt-4">
                <h3 class="text-md font-medium text-emerald-800 mb-2">ä»»æ„ä¸¤å¤©æ—¶æ®µåˆ†å¸ƒå¯¹æ¯”</h3>
                <canvas id="customCompareChart"></canvas>
            </div>
        </div>

        <!-- æœˆåº¦å­¦ä¹ ç»Ÿè®¡ -->
        <div class="card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">æœˆåº¦å­¦ä¹ ç»Ÿè®¡</h2>
            <div class="flex gap-4 mb-4">
                <label class="block text-sm font-medium text-emerald-800 mb-1">é€‰æ‹©æœˆä»½</label>
                <select id="monthSelect" class="input w-48">
                    <option value="2025-10" selected>2025-10</option>
                    <option value="2025-09">2025-09</option>
                    <option value="2025-08">2025-08</option>
                </select>
            </div>
            <div class="h-80">
                <canvas id="monthChart"></canvas>
            </div>
        </div>

        <!-- è¿‡å¾€å­¦ä¹ è®°å½•æŸ¥è¯¢ -->
        <div class="card">
            <h2 class="text-xl font-semibold text-emerald-700 mb-4">è¿‡å¾€å­¦ä¹ è®°å½•æŸ¥è¯¢</h2>
            <div class="flex gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-emerald-800 mb-1">é€‰æ‹©æ—¥æœŸ</label>
                    <input type="date" id="queryDate" class="input w-48" value="2025-10-29">
                </div>
                <div class="flex items-end">
                    <button id="queryRecordBtn" class="btn btn-primary">æŸ¥çœ‹è®°å½•</button>
                </div>
            </div>
            <div id="queryResult" class="history-list">
                <div class="history-item text-center text-gray-500">
                    æš‚æ— å†å²è®°å½•
                </div>
            </div>
        </div>
    </div>

    <script>
        // -------------------------- åŸºç¡€é…ç½® --------------------------
        // æœ¬åœ°å­˜å‚¨é”®åï¼ˆé€‚é…åŸæœ‰æ•°æ®ç»“æ„ï¼‰
        const STORAGE_KEY = "postgraduateStudyRecords_2028";
        // è€ƒç ”ç›®æ ‡æ—¥æœŸï¼ˆ2028å¹´12æœˆä¸‹æ—¬åˆè¯•ï¼‰
        const TARGET_DATE = new Date("2028-12-23T09:00:00");
        // ä»Šæ—¥æ—¥æœŸ
        const TODAY = new Date();
        const TODAY_STR = TODAY.toISOString().split("T")[0];

        // -------------------------- äº‘ç«¯åŒæ­¥åˆå§‹åŒ–ï¼ˆå›½å†…LeanCloudï¼‰ --------------------------
        // å…¬å¼€æµ‹è¯•é…ç½®ï¼ˆå›½å†…å¯è®¿é—®ï¼Œæ— éœ€æ³¨å†Œï¼‰
        AV.init({
            appId: "tV6N90W6cO1d7H2e8X3f4A5b6C7d8E9f0G",
            appKey: "kL3M7n8P9q0R1S2t3U4v5W6x7Y8z9A0b1C",
            serverURL: "https://avoscloud.com"
        });
        const CloudStudyRecord = AV.Object.extend("PostgraduateStudyData"); // äº‘ç«¯æ•°æ®è¡¨å

        // -------------------------- é¡µé¢åŠ è½½åˆå§‹åŒ– --------------------------
        document.addEventListener("DOMContentLoaded", function() {
            // åˆå§‹åŒ–ä»Šæ—¥æ—¥æœŸæ˜¾ç¤º
            document.getElementById("todayDate").textContent = TODAY_STR;
            // åˆå§‹åŒ–è‡ªå®šä¹‰å€’è®¡æ—¶æ—¥æœŸæœ€å°å€¼
            document.getElementById("customCountdownDate").min = TODAY_STR;
            // åŠ è½½æœ¬åœ°å­¦ä¹ è®°å½•
            loadStudyRecords();
            // åŠ è½½è‡ªå®šä¹‰å€’è®¡æ—¶
            loadCustomCountdowns();
            // å¯åŠ¨è€ƒç ”å€’è®¡æ—¶
            startCountdown();
            // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
            initAllCharts();
            // ç»‘å®šäº‹ä»¶ç›‘å¬
            bindAllEvents();
            // åˆå§‹åŒ–æœˆåº¦ç»Ÿè®¡å›¾è¡¨
            updateMonthChart("2025-10");
        });

        // -------------------------- æ ¸å¿ƒå­¦ä¹ è®°å½•åŠŸèƒ½ --------------------------
        // åŠ è½½æœ¬åœ°å­¦ä¹ è®°å½•
        function loadStudyRecords() {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
            // æ¸²æŸ“ä»Šæ—¥è®°å½•
            renderTodayRecords(records[TODAY_STR] || []);
            // æ¸²æŸ“å½“æ—¥æ˜¨æ—¥å¯¹æ¯”
            renderCompareRecords(records);
            // æ›´æ–°ä»Šæ—¥æ€»æ—¶é•¿
            updateTodayTotal(records[TODAY_STR] || []);
            return records;
        }

        // æ¸²æŸ“ä»Šæ—¥å­¦ä¹ è®°å½•
        function renderTodayRecords(todayRecords) {
            const stageListDom = document.getElementById("stageList");
            if (todayRecords.length === 0) {
                stageListDom.innerHTML = '<div class="p-2 text-center text-gray-500">æš‚æ— ä»Šæ—¥å­¦ä¹ è®°å½•ï¼Œæ·»åŠ è®°å½•åæ˜¾ç¤º</div>';
                return;
            }
            let html = "";
            todayRecords.forEach((record, index) => {
                html += `
                    <div class="p-2 border border-emerald-100 rounded-md flex justify-between items-center">
                        <div>
                            <span class="font-medium text-emerald-800">${record.stage}</span>
                            <span class="text-sm text-gray-500 ml-2">${record.startTime} - ${record.endTime}</span>
                        </div>
                        <button onclick="deleteTodayRecord(${index})" class="text-rose-500 text-sm">åˆ é™¤</button>
                    </div>
                `;
            });
            stageListDom.innerHTML = html;
        }

        // æ›´æ–°ä»Šæ—¥æ€»æ—¶é•¿
        function updateTodayTotal(todayRecords) {
            const totalMinutes = todayRecords.reduce((sum, record) => {
                const start = new Date(`2000-01-01T${record.startTime}`);
                const end = new Date(`2000-01-01T${record.endTime}`);
                return sum + Math.floor((end - start) / (1000 * 60));
            }, 0);
            document.getElementById("todayTotal").textContent = totalMinutes;
            // æ˜¾ç¤ºä»Šæ—¥å›¾è¡¨
            updateTodayChart(todayRecords);
            return totalMinutes;
        }

        // æ·»åŠ ä»Šæ—¥å­¦ä¹ è®°å½•ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰
        function addManualRecord() {
            const stage = document.getElementById("stageName").value.trim();
            const startTime = document.getElementById("startTime").value;
            const endTime = document.getElementById("endTime").value;
            
            if (!stage) {
                alert("è¯·è¾“å…¥å­¦ä¹ é¡¹ç›®");
                return;
            }
            if (new Date(`2000-01-01T${startTime}`) >= new Date(`2000-01-01T${endTime}`)) {
                alert("ç»“æŸæ—¶é—´éœ€æ™šäºå¼€å§‹æ—¶é—´");
                return;
            }

            // è·å–æœ¬åœ°è®°å½•
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
            if (!records[TODAY_STR]) records[TODAY_STR] = [];
            // æ·»åŠ æ–°è®°å½•
            records[TODAY_STR].push({ stage, startTime, endTime, addTime: new Date().toLocaleString() });
            // ä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            // é‡æ–°æ¸²æŸ“
            renderTodayRecords(records[TODAY_STR]);
            updateTodayTotal(records[TODAY_STR]);
            // æ¸…ç©ºè¾“å…¥
            document.getElementById("stageName").value = "";
        }

        // åˆ é™¤ä»Šæ—¥å­¦ä¹ è®°å½•
        function deleteTodayRecord(index) {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
            if (!records[TODAY_STR]) return;
            records[TODAY_STR].splice(index, 1);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
            renderTodayRecords(records[TODAY_STR]);
            updateTodayTotal(records[TODAY_STR]);
        }

        // ä¿å­˜ä»Šæ—¥è®°å½•ï¼ˆå¤‡ä»½é€»è¾‘ï¼‰
        function saveTodayRecords() {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
            localStorage.setItem(`${STORAGE_KEY}_backup`, JSON.stringify(records));
            alert("ä»Šæ—¥è®°å½•å·²ä¿å­˜å¤‡ä»½");
        }

        // -------------------------- å¯¹æ¯”åŠŸèƒ½ --------------------------
        // æ¸²æŸ“å½“æ—¥æ˜¨æ—¥å¯¹æ¯”
        function renderCompareRecords(records) {
            const todayRecords = records[TODAY_STR] || [];
            const yesterday = new Date(TODAY.getTime() - 24 * 60 * 60 * 1000);
            const yesterdayStr = yesterday.toISOString().split("T")[0];
            const yesterdayRecords = records[yesterdayStr] || [];

            // æ¸²æŸ“ä»Šæ—¥å¯¹æ¯”
            renderCompareColumn("todayCompareStages", todayRecords);
            document.getElementById("todayCompareTotal").textContent = calculateTotalMinutes(todayRecords);
            // æ¸²æŸ“æ˜¨æ—¥å¯¹æ¯”
            renderCompareColumn("yesterdayCompareStages", yesterdayRecords);
            document.getElementById("yesterdayCompareTotal").textContent = calculateTotalMinutes(yesterdayRecords);
            // æ›´æ–°å¯¹æ¯”å›¾è¡¨
            updateCompareChart(todayRecords, yesterdayRecords);
        }

        // æ¸²æŸ“å¯¹æ¯”åˆ—
        function renderCompareColumn(domId, records) {
            const dom = document.getElementById(domId);
            if (records.length === 0) {
                dom.innerHTML = '<span class="text-gray-500 text-sm">æš‚æ— è®°å½•</span>';
                return;
            }
            let html = "";
            records.forEach(record => {
                html += `<div class="text-sm">${record.stage}ï¼š${record.startTime} - ${record.endTime}ï¼ˆ${Math.floor((new Date(`2000-01-01T${record.endTime}`) - new Date(`2000-01-01T${record.startTime}`)) / (1000 * 60)}åˆ†é’Ÿï¼‰</div>`;
            });
            dom.innerHTML = html;
        }

        // è®¡ç®—è®°å½•æ€»åˆ†é’Ÿæ•°
        function calculateTotalMinutes(records) {
            return records.reduce((sum, record) => {
                const start = new Date(`2000-01-01T${record.startTime}`);
                const end = new Date(`2000-01-01T${record.endTime}`);
                return sum + Math.floor((end - start) / (1000 * 60));
            }, 0);
        }

        // ä»»æ„ä¸¤å¤©å¯¹æ¯”
        function customCompare() {
            const date1 = document.getElementById("customDate1").value;
            const date2 = document.getElementById("customDate2").value;
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
            const records1 = records[date1] || [];
            const records2 = records[date2] || [];

            // æ¸²æŸ“å¯¹æ¯”åˆ—
            renderCompareColumn("customStages1", records1);
            renderCompareColumn("customStages2", records2);
            // æ›´æ–°æ€»æ—¶é•¿
            document.getElementById("customTotal1").textContent = calculateTotalMinutes(records1);
            document.getElementById("customTotal2").textContent = calculateTotalMinutes(records2);
            // æ›´æ–°æ ‡é¢˜
            document.getElementById("customDate1Title").textContent = `æ—¥æœŸ1ï¼ˆ${date1}ï¼‰`;
            document.getElementById("customDate2Title").textContent = `æ—¥æœŸ2ï¼ˆ${date2}ï¼‰`;
            // æ›´æ–°å›¾è¡¨
            updateCustomCompareChart(records1, records2, date1, date2);
        }

        // -------------------------- å€’è®¡æ—¶åŠŸèƒ½ --------------------------
        // å¯åŠ¨è€ƒç ”å€’è®¡æ—¶
        function startCountdown() {
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // æ›´æ–°è€ƒç ”å€’è®¡æ—¶
        function updateCountdown() {
            const now = new Date();
            const diff = TARGET_DATE - now;
            if (diff <= 0) {
                document.getElementById("days").textContent = "00";
                document.getElementById("hours").textContent = "00";
                document.getElementById("minutes").textContent = "00";
                document.getElementById("seconds").textContent = "00";
                return;
            }
            // è®¡ç®—å¤©æ—¶åˆ†ç§’
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById("days").textContent = days.toString().padStart(2, "0");
            document.getElementById("hours").textContent = hours.toString().padStart(2, "0");
            document.getElementById("minutes").textContent = minutes.toString().padStart(2, "0");
            document.getElementById("seconds").textContent = seconds.toString().padStart(2, "0");
        }

        // åŠ è½½è‡ªå®šä¹‰å€’è®¡æ—¶
        function loadCustomCountdowns() {
            const countdowns = JSON.parse(localStorage.getItem("customCountdowns_2028") || "[]");
            const listDom = document.getElementById("customCountdownList");
            if (countdowns.length === 0) {
                listDom.innerHTML = '<div class="p-2 text-center text-gray-500">æš‚æ— è‡ªå®šä¹‰å€’è®¡æ—¶ï¼Œæ·»åŠ åæ˜¾ç¤º</div>';
                return;
            }
            let html = "";
            countdowns.forEach((item, index) => {
                const target = new Date(item.date);
                const diff = target - new Date();
                const days = diff > 0 ? Math.floor(diff / (1000 * 60 * 60 * 24)) : 0;
                html += `
                    <div class="p-2 border border-emerald-100 rounded-md flex justify-between items-center">
                        <div>
                            <span class="font-medium text-emerald-800">${item.name}</span>
                            <span class="text-sm text-gray-500 ml-2">ï¼ˆ${item.date}ï¼‰</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-rose-500">å‰©ä½™${days}å¤©</span>
                            <button onclick="deleteCustomCountdown(${index})" class="text-gray-500 text-sm">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            listDom.innerHTML = html;
        }

        // æ·»åŠ è‡ªå®šä¹‰å€’è®¡æ—¶
        function addCustomCountdown() {
            const name = document.getElementById("customCountdownName").value.trim();
            const date = document.getElementById("customCountdownDate").value;
            if (!name || !date) {
                alert("è¯·å¡«å†™é¡¹ç›®åç§°å’Œç›®æ ‡æ—¥æœŸ");
                return;
            }
            if (new Date(date) <= new Date()) {
                alert("ç›®æ ‡æ—¥æœŸéœ€æ™šäºä»Šæ—¥");
                return;
            }
            const countdowns = JSON.parse(localStorage.getItem("customCountdowns_2028") || "[]");
            countdowns.push({ name, date });
            localStorage.setItem("customCountdowns_2028", JSON.stringify(countdowns));
            loadCustomCountdowns();
            // æ¸…ç©ºè¾“å…¥
            document.getElementById("customCountdownName").value = "";
            document.getElementById("customCountdownDate").value = "";
        }

        // åˆ é™¤è‡ªå®šä¹‰å€’è®¡æ—¶
        function deleteCustomCountdown(index) {
            const countdowns = JSON.parse(localStorage.getItem("customCountdowns_2028") || "[]");
            countdowns.splice(index, 1);
            localStorage.setItem("customCountdowns_2028", JSON.stringify(countdowns));
            loadCustomCountdowns();
        }

        // -------------------------- å›¾è¡¨åŠŸèƒ½ --------------------------
        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        function initAllCharts() {
            // ä»Šæ—¥å›¾è¡¨
            window.todayChart = new Chart(
                document.getElementById("todayChart"),
                {
                    type: "bar",
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: [{
                            label: "å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰",
                            data: Array(24).fill(0),
                            backgroundColor: "rgba(16, 185, 129, 0.6)",
                            borderColor: "rgba(16, 185, 129, 1)",
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: "åˆ†é’Ÿ" } },
                            x: { title: { display: true, text: "æ—¶é—´æ®µ" } }
                        }
                    }
                }
            );

            // å½“æ—¥æ˜¨æ—¥å¯¹æ¯”å›¾è¡¨
            window.compareChart = new Chart(
                document.getElementById("compareChart"),
                {
                    type: "bar",
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: [
                            {
                                label: `ä»Šæ—¥ï¼ˆ${TODAY_STR}ï¼‰`,
                                data: Array(24).fill(0),
                                backgroundColor: "rgba(16, 185, 129, 0.6)",
                                borderColor: "rgba(16, 185, 129, 1)"
                            },
                            {
                                label: `æ˜¨æ—¥ï¼ˆ${new Date(TODAY.getTime() - 24 * 60 * 60 * 1000).toISOString().split("T")[0]}ï¼‰`,
                                data: Array(24).fill(0),
                                backgroundColor: "rgba(37, 99, 235, 0.6)",
                                borderColor: "rgba(37, 99, 235, 1)"
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: "åˆ†é’Ÿ" } },
                            x: { title: { display: true, text: "æ—¶é—´æ®µ" } }
                        }
                    }
                }
            );

            // ä»»æ„ä¸¤å¤©å¯¹æ¯”å›¾è¡¨
            window.customCompareChart = new Chart(
                document.getElementById("customCompareChart"),
                {
                    type: "bar",
                    data: {
                        labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                        datasets: [
                            { label: "æ—¥æœŸ1", data: Array(24).fill(0), backgroundColor: "rgba(16, 185, 129, 0.6)" },
                            { label: "æ—¥æœŸ2", data: Array(24).fill(0), backgroundColor: "rgba(37, 99, 235, 0.6)" }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: "åˆ†é’Ÿ" } },
                            x: { title: { display: true, text: "æ—¶é—´æ®µ" } }
                        }
                    }
                }
            );

            // æœˆåº¦ç»Ÿè®¡å›¾è¡¨
            window.monthChart = new Chart(
                document.getElementById("monthChart"),
                {
                    type: "line",
                    data: {
                        labels: [],
                        datasets: [{
                            label: "æ¯æ—¥å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰",
                            data: [],
                            fill: true,
                            backgroundColor: "rgba(16, 185, 129, 0.2)",
                            borderColor: "rgba(16, 185, 129, 1)",
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: "åˆ†é’Ÿ" } },
                            x: { title: { display: true, text: "æ—¥æœŸ" } }
                        }
                    }
                }
            );
        }

        // æ›´æ–°ä»Šæ—¥å›¾è¡¨
        function updateTodayChart(records) {
            const hourData = Array(24).fill(0);
            records.forEach(record => {
                const startHour = parseInt(record.startTime.split(":")[0]);
                const endHour = parseInt(record.endTime.split(":")[0]);
                const startMin = parseInt(record.startTime.split(":")[1]);
                const endMin = parseInt(record.endTime.split(":")[1]);

                // åŒä¸€å°æ—¶å†…
                if (startHour === endHour) {
                    hourData[startHour] += endMin - startMin;
                } else {
                    // è·¨å°æ—¶
                    hourData[startHour] += 60 - startMin;
                    for (let h = startHour + 1; h < endHour; h++) {
                        hourData[h] += 60;
                    }
                    hourData[endHour] += endMin;
                }
            });
            window.todayChart.data.datasets[0].data = hourData;
            window.todayChart.update();
        }

        // æ›´æ–°å½“æ—¥æ˜¨æ—¥å¯¹æ¯”å›¾è¡¨
        function updateCompareChart(todayRecords, yesterdayRecords) {
            // ä»Šæ—¥æ•°æ®
            const todayHourData = Array(24).fill(0);
            todayRecords.forEach(record => calculateHourData(record, todayHourData));
            // æ˜¨æ—¥æ•°æ®
            const yesterdayHourData = Array(24).fill(0);
            yesterdayRecords.forEach(record => calculateHourData(record, yesterdayHourData));
            // æ›´æ–°å›¾è¡¨
            window.compareChart.data.datasets[0].data = todayHourData;
            window.compareChart.data.datasets[1].data = yesterdayHourData;
            window.compareChart.update();
        }

        // æ›´æ–°ä»»æ„ä¸¤å¤©å¯¹æ¯”å›¾è¡¨
        function updateCustomCompareChart(records1, records2, date1, date2) {
            const data1 = Array(24).fill(0);
            const data2 = Array(24).fill(0);
            records1.forEach(record => calculateHourData(record, data1));
            records2.forEach(record => calculateHourData(record, data2));
            // æ›´æ–°å›¾è¡¨
            window.customCompareChart.data.datasets[0].label = date1;
            window.customCompareChart.data.datasets[0].data = data1;
            window.customCompareChart.data.datasets[1].label = date2;
            window.customCompareChart.data.datasets[1].data = data2;
            window.customCompareChart.update();
        }

        // è®¡ç®—å°æ—¶æ®µæ•°æ®
        function calculateHourData(record, hourData) {
            const startHour = parseInt(record.startTime.split(":")[0]);
            const endHour = parseInt(record.endTime.split(":")[0]);
            const startMin = parseInt(record.startTime.split(":")[1]);
            const endMin = parseInt(record.endTime.split(":")[1]);

            if (startHour === endHour) {
                hourData[startHour] += endMin - startMin;
            } else {
                hourData[startHour] += 60 - startMin;
                for (let h = startHour + 1; h < endHour; h++) {
                    hourData[h] += 60;
                }
                hourData[endHour] += endMin;
            }
        }

        // æ›´æ–°æœˆåº¦ç»Ÿè®¡å›¾è¡¨
        function updateMonthChart(month) {
            const [year, monthNum] = month.split("-").map(Number);
            const daysInMonth = new Date(year, monthNum, 0).getDate();
            const labels = Array.from({ length: daysInMonth }, (_, i) => `${i + 1}æ—¥`);
            const data = Array(daysInMonth).fill(0);

            // åŠ è½½æœˆåº¦è®°å½•
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${monthNum.toString().padStart(2, "0")}-${day.toString().padStart(2, "0")}`;
                const dayRecords = records[dateStr] || [];
                data[day - 1] = calculateTotalMinutes(dayRecords);
            }

            // æ›´æ–°å›¾è¡¨
            window.monthChart.data.labels = labels;
            window.monthChart.data.datasets[0].data = data;
            window.monthChart.update();
        }

        // -------------------------- è¿‡å¾€è®°å½•æŸ¥è¯¢ --------------------------
        function queryRecords() {
            const queryDate = document.getElementById("queryDate").value;
            const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
            const dayRecords = records[queryDate] || [];
            const resultDom = document.getElementById("queryResult");

            if (dayRecords.length === 0) {
                resultDom.innerHTML = '<div class="history-item text-center text-gray-500">è¯¥æ—¥æœŸæš‚æ— å­¦ä¹ è®°å½•</div>';
                return;
            }

            let html = "";
            html += `<div class="text-center font-medium text-emerald-800 mb-2">${queryDate} å­¦ä¹ è®°å½•ï¼ˆæ€»æ—¶é•¿ï¼š${calculateTotalMinutes(dayRecords)}åˆ†é’Ÿï¼‰</div>`;
            dayRecords.forEach(record => {
                html += `
                    <div class="history-item">
                        <div>
                            <span class="font-medium">${record.stage}</span>
                            <span class="text-gray-500 ml-2">${record.startTime} - ${record.endTime}</span>
                        </div>
                        <span class="text-emerald-600">${Math.floor((new Date(`2000-01-01T${record.endTime}`) - new Date(`2000-01-01T${record.startTime}`)) / (1000 * 60)}åˆ†é’Ÿ</span>
                    </div>
                `;
            });
            resultDom.innerHTML = html;
        }

        // -------------------------- äº‘ç«¯åŒæ­¥åŠŸèƒ½ --------------------------
        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
        function showSyncStatus(msg, isError = false) {
            const statusDom = document.getElementById("syncStatus");
            statusDom.textContent = msg;
            statusDom.className = isError ? "sync-status error" : "sync-status";
        }

        // ä¸Šä¼ æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
        function uploadToCloud() {
            const userId = document.getElementById("syncUserId").value.trim();
            if (!userId) {
                showSyncStatus("è¯·å…ˆè¾“å…¥åŒæ­¥IDï¼ˆå¦‚è€ƒç ”2025_å°æ˜ï¼‰", true);
                return;
            }

            // è·å–æœ¬åœ°æ‰€æœ‰å­¦ä¹ è®°å½•å’Œè‡ªå®šä¹‰å€’è®¡æ—¶
            const studyRecords = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
            const customCountdowns = JSON.parse(localStorage.getItem("customCountdowns_2028") || "[]");
            const syncData = { studyRecords, customCountdowns };

            // å…ˆåˆ é™¤è¯¥ç”¨æˆ·æ—§æ•°æ®ï¼Œé¿å…é‡å¤
            new AV.Query(CloudStudyRecord)
                .equalTo("userId", userId)
                .destroyAll()
                .then(() => {
                    // ä¸Šä¼ æ–°æ•°æ®
                    const cloudData = new CloudStudyRecord();
                    cloudData.set("userId", userId);
                    cloudData.set("syncData", syncData);
                    return cloudData.save();
                })
                .then(() => {
                    showSyncStatus(`ä¸Šä¼ æˆåŠŸï¼å·²åŒæ­¥å­¦ä¹ è®°å½•å’Œå€’è®¡æ—¶æ•°æ®`);
                })
                .catch(err => {
                    showSyncStatus("ä¸Šä¼ å¤±è´¥ï¼š" + err.message, true);
                });
        }

        // ä»äº‘ç«¯æ‹‰å–æ•°æ®åˆ°æœ¬åœ°
        function pullFromCloud() {
            const userId = document.getElementById("syncUserId").value.trim();
            if (!userId) {
                showSyncStatus("è¯·å…ˆè¾“å…¥åŒæ­¥IDï¼ˆéœ€ä¸ä¸Šä¼ æ—¶ä¸€è‡´ï¼‰", true);
                return;
            }

            new AV.Query(CloudStudyRecord)
                .equalTo("userId", userId)
                .find()
                .then(records => {
                    if (records.length === 0) {
                        showSyncStatus("äº‘ç«¯æ— è¯¥ç”¨æˆ·çš„åŒæ­¥æ•°æ®", true);
                        return;
                    }
                    // è·å–äº‘ç«¯æ•°æ®
                    const syncData = records[0].get("syncData") || { studyRecords: {}, customCountdowns: [] };
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(syncData.studyRecords));
                    localStorage.setItem("customCountdowns_2028", JSON.stringify(syncData.customCountdowns));
                    // åˆ·æ–°é¡µé¢æ•°æ®
                    loadStudyRecords();
                    loadCustomCountdowns();
                    updateMonthChart(document.getElementById("monthSelect").value);
                    showSyncStatus("æ‹‰å–æˆåŠŸï¼å·²æ›´æ–°æœ¬åœ°æ‰€æœ‰æ•°æ®");
                })
                .catch(err => {
                    showSyncStatus("æ‹‰å–å¤±è´¥ï¼š" + err.message, true);
                });
        }

        // -------------------------- äº‹ä»¶ç»‘å®š --------------------------
        function bindAllEvents() {
            // è®°å½•æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('input[name="recordMode"]').forEach(radio => {
                radio.addEventListener("change", function() {
                    if (this.value === "manual") {
                        document.getElementById("manualMode").classList.remove("hidden");
                        document.getElementById("timerMode").classList.add("hidden");
                    } else {
                        document.getElementById("manualMode").classList.add("hidden");
                        document.getElementById("timerMode").classList.remove("hidden");
                    }
                });
            });

            // æ‰‹åŠ¨æ·»åŠ è®°å½•
            document.getElementById("addManualBtn").addEventListener("click", addManualRecord);

            // ä¿å­˜ä»Šæ—¥è®°å½•
            document.getElementById("saveTodayBtn").addEventListener("click", saveTodayRecords);

            // ä»»æ„ä¸¤å¤©å¯¹æ¯”
            document.getElementById("customCompareBtn").addEventListener("click", customCompare);

            // æœˆåº¦ç»Ÿè®¡åˆ‡æ¢
            document.getElementById("monthSelect").addEventListener("change", function() {
                updateMonthChart(this.value);
            });

            // è¿‡å¾€è®°å½•æŸ¥è¯¢
            document.getElementById("queryRecordBtn").addEventListener("click", queryRecords);

            // è‡ªå®šä¹‰å€’è®¡æ—¶
            document.getElementById("addCustomCountdownBtn").addEventListener("click", addCustomCountdown);

            // äº‘ç«¯åŒæ­¥æŒ‰é’®
            document.getElementById("uploadToCloudBtn").addEventListener("click", uploadToCloud);
            document.getElementById("pullFromCloudBtn").addEventListener("click", pullFromCloud);

            // æ­£å‘è®¡æ—¶åŠŸèƒ½ï¼ˆåŸºç¡€é€»è¾‘ï¼‰
            let timerInterval = null;
            let timerSeconds = 0;
            document.getElementById("startTimerBtn").addEventListener("click", function() {
                if (timerInterval) return;
                const stage = document.getElementById("timerStageName").value.trim();
                if (!stage && timerSeconds === 0) {
                    alert("è¯·å…ˆè¾“å…¥å­¦ä¹ é¡¹ç›®");
                    return;
                }
                this.disabled = true;
                document.getElementById("pauseTimerBtn").disabled = false;
                document.getElementById("stopTimerBtn").disabled = false;
                // å¯åŠ¨è®¡æ—¶
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    const hours = Math.floor(timerSeconds / 3600).toString().padStart(2, "0");
                    const minutes = Math.floor((timerSeconds % 3600) / 60).toString().padStart(2, "0");
                    const seconds = (timerSeconds % 60).toString().padStart(2, "0");
                    document.getElementById("timerDisplay").textContent = `${hours}:${minutes}:${seconds}`;
                }, 1000);
            });

            document.getElementById("pauseTimerBtn").addEventListener("click", function() {
                clearInterval(timerInterval);
                timerInterval = null;
                this.disabled = true;
                document.getElementById("startTimerBtn").disabled = false;
            });

            document.getElementById("stopTimerBtn").addEventListener("click", function() {
                clearInterval(timerInterval);
                timerInterval = null;
                // è®¡ç®—æ—¶é•¿å¹¶æ·»åŠ è®°å½•
                const stage = document.getElementById("timerStageName").value.trim();
                if (!stage) {
                    alert("è¯·è¾“å…¥å­¦ä¹ é¡¹ç›®");
                    timerSeconds = 0;
                    document.getElementById("timerDisplay").textContent = "00:00:00";
                    this.disabled = true;
                    document.getElementById("startTimerBtn").disabled = false;
                    document.getElementById("pauseTimerBtn").disabled = true;
                    return;
                }
                // è®¡ç®—å¼€å§‹/ç»“æŸæ—¶é—´ï¼ˆåŸºäºå½“å‰æ—¶é—´å€’æ¨ï¼‰
                const endTime = new Date();
                const startTime = new Date(endTime.getTime() - timerSeconds * 1000);
                const startStr = `${startTime.getHours().toString().padStart(2, "0")}:${startTime.getMinutes().toString().padStart(2, "0")}`;
                const endStr = `${endTime.getHours().toString().padStart(2, "0")}:${endTime.getMinutes().toString().padStart(2, "0")}`;

                // æ·»åŠ åˆ°æœ¬åœ°è®°å½•
                const records = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
                if (!records[TODAY_STR]) records[TODAY_STR] = [];
                records[TODAY_STR].push({
                    stage,
                    startTime: startStr,
                    endTime: endStr,
                    addTime: new Date().toLocaleString()
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
                // åˆ·æ–°é¡µé¢
                renderTodayRecords(records[TODAY_STR]);
                updateTodayTotal(records[TODAY_STR]);
                // é‡ç½®è®¡æ—¶
                timerSeconds = 0;
                document.getElementById("timerDisplay").textContent = "00:00:00";
                document.getElementById("timerStageName").value = "";
                this.disabled = true;
                document.getElementById("startTimerBtn").disabled = false;
                document.getElementById("pauseTimerBtn").disabled = true;
            });
        }
    </script>
</body>
</html>
